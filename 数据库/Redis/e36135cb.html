<!-- build time:Fri Aug 02 2019 20:11:52 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Redis,"><link rel="alternate" href="/atom.xml" title="飘絮不飘" type="application/atom+xml"><meta name="description" content="Redis事物什么是事物事物是指一系列操作步骤，这一系列的操作步骤，要么完全地执行，要么完全地不执行。Redis中的事物(transaction)是一组命令的集合，至少是两个或两个以上的命令，redis事物保证这些命令被执行时中间不会被任何其他操作打断。事物操作的命令multi语法: multi作用: 标记一个事物的开始。事物内的多条命令会按照先后顺序被放到一个队列当中。返回值: 总是返回OKex"><meta name="keywords" content="Redis"><meta property="og:type" content="article"><meta property="og:title" content="第4章 高级话题"><meta property="og:url" content="http://smartdot.club/数据库/Redis/e36135cb.html"><meta property="og:site_name" content="飘絮不飘"><meta property="og:description" content="Redis事物什么是事物事物是指一系列操作步骤，这一系列的操作步骤，要么完全地执行，要么完全地不执行。Redis中的事物(transaction)是一组命令的集合，至少是两个或两个以上的命令，redis事物保证这些命令被执行时中间不会被任何其他操作打断。事物操作的命令multi语法: multi作用: 标记一个事物的开始。事物内的多条命令会按照先后顺序被放到一个队列当中。返回值: 总是返回OKex"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://smartdot.club/images/redis/redis123.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis124.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis125.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis126.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis127.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis128.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis129.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis130.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis131.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis132.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis133.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis134.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis135.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis136.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis137.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis138.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis139.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis140.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis141.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis142.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis143.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis144.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis145.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis146.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis147.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis148.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis149.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis150.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis151.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis152.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis153.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis154.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis155.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis156.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis157.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis158.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis159.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis160.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis161.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis162.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis163.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis164.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis165.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis166.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis167.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis168.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis169.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis170.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis171.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis172.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis173.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis174.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis175.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis176.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis177.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis178.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis179.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis180.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis181.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis182.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis183.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis184.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis185.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis186.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis187.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis188.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis189.png"><meta property="og:image" content="http://smartdot.club/images/redis/redis190.png"><meta property="og:updated_time" content="2019-08-02T11:59:11.773Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="第4章 高级话题"><meta name="twitter:description" content="Redis事物什么是事物事物是指一系列操作步骤，这一系列的操作步骤，要么完全地执行，要么完全地不执行。Redis中的事物(transaction)是一组命令的集合，至少是两个或两个以上的命令，redis事物保证这些命令被执行时中间不会被任何其他操作打断。事物操作的命令multi语法: multi作用: 标记一个事物的开始。事物内的多条命令会按照先后顺序被放到一个队列当中。返回值: 总是返回OKex"><meta name="twitter:image" content="http://smartdot.club/images/redis/redis123.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://smartdot.club/数据库/Redis/e36135cb.html"><title>第4章 高级话题 | 飘絮不飘</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6eab8e406784737599c55375c44984da";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><a href="https://github.com/caifenglin"><img style="position:absolute;top:0;left:0;border:0;z-index:999999" src="https://s3.amazonaws.com/github/ribbons/forkme_left_white_ffffff.png" alt="Fork me on GitHub"></a><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">飘絮不飘</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">CaiFengLin</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="menu-item-icon fa fa-fw fa-calendar"></i><br>日程表</a></li><li class="menu-item menu-item-application"><a href="/application" rel="section"><i class="menu-item-icon fa fa-fw fa-download"></i><br>application</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>公益404</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://smartdot.club/数据库/Redis/e36135cb.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="caifenglin"><meta itemprop="description" content><meta itemprop="image" content="/images/information/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="飘絮不飘"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">第4章 高级话题</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-02T20:17:09+08:00">2019-03-02 </time><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于&#58;</span> <time title="更新于" itemprop="dateModified" datetime="2019-08-02T19:59:11+08:00">2019-08-02 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/数据库/" itemprop="url" rel="index"><span itemprop="name">数据库</span> </a></span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/数据库/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span> </a></span></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/数据库/Redis/e36135cb.html#comments" itemprop="discussionUrl"><span class="post-comments-count gitment-comments-count" data-xid="/数据库/Redis/e36135cb.html" itemprop="commentsCount"></span></a></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">5.6k </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">20</span></div></div></header><div class="post-body" itemprop="articleBody"><h3 id="Redis事物"><a href="#Redis事物" class="headerlink" title="Redis事物"></a>Redis事物</h3><h4 id="什么是事物"><a href="#什么是事物" class="headerlink" title="什么是事物"></a>什么是事物</h4><p>事物是指一系列操作步骤，这一系列的操作步骤，要么完全地执行，要么完全地不执行。<br>Redis中的事物(transaction)是一组命令的集合，至少是两个或两个以上的命令，redis事物保证这些命令被执行时中间不会被任何其他操作打断。</p><h4 id="事物操作的命令"><a href="#事物操作的命令" class="headerlink" title="事物操作的命令"></a>事物操作的命令</h4><h5 id="multi"><a href="#multi" class="headerlink" title="multi"></a>multi</h5><p>语法: multi<br>作用: 标记一个事物的开始。事物内的多条命令会按照先后顺序被放到一个队列当中。<br>返回值: 总是返回OK</p><h5 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h5><p>语法: exec<br>作用: 执行所有事物块内的命令<br>返回值: 事物内的所有执行语句内容，事物被打断(影响)返回nil</p><h5 id="discard"><a href="#discard" class="headerlink" title="discard"></a>discard</h5><p>语法: discard<br>作用: 取消事物，放弃执行事物块内的所有命令<br>返回值: 总是返回OK</p><h5 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h5><p>语法: watch key [key···]<br>作用: 监视一个(或多个)key，如果在事物执行之前这个(或这些)key被其他命令所改动，那么事物将被打断。<br>返回值: 总是返回OK</p><h5 id="unwatch"><a href="#unwatch" class="headerlink" title="unwatch"></a>unwatch</h5><p>语法: unwatch<br>作用: 取消WATCH命令对所有key的监视。如果在执行WATCH命令之后，EXEC命令或DISCARD命令先被执行了的话，那么就不需要在执行UNWATCH了<br>返回值: 总是返回OK</p><h4 id="事物的实现"><a href="#事物的实现" class="headerlink" title="事物的实现"></a>事物的实现</h4><h5 id="正常执行事物"><a href="#正常执行事物" class="headerlink" title="正常执行事物"></a>正常执行事物</h5><p>事物的执行步骤: 首先开启事物，其次向事物队列中加入命令，最后执行事物提交。<br>例1: 事物的执行：<br>1) multi：用multi命令告诉Redis，接下来要执行的命令你先不要执行，而是把它们暂时存起来(开启事物)<br>2) sadd works john 第一条命令进入等待队列(命令入队)<br>3) sadd works rose 第二条命令进入等待队列(命令入队)<br>4) exce 告知redis执行前面发送的两条命令(提交事物)<br><img src="/images/redis/redis123.png" alt="Redis"><br>查看works集合<br><img src="/images/redis/redis124.png" alt="Redis"></p><h5 id="事物执行exec之前，入队命令错误-语法错误；严重错误导致服务器不能正常工作-例如内存不足-放弃事物。"><a href="#事物执行exec之前，入队命令错误-语法错误；严重错误导致服务器不能正常工作-例如内存不足-放弃事物。" class="headerlink" title="事物执行exec之前，入队命令错误(语法错误；严重错误导致服务器不能正常工作(例如内存不足)),放弃事物。"></a>事物执行exec之前，入队命令错误(语法错误；严重错误导致服务器不能正常工作(例如内存不足)),放弃事物。</h5><p>执行事物步骤:<br>1) MULTI 正常命令<br>2) SET key value 正常命令<br>3) INCR 命令语法错误<br>4) EXEC 无法执行事物，那么第一条正确的命令也不会执行，所有key的值不会设置成功。<br><img src="/images/redis/redis125.png" alt="Redis"><br>结论: 事物执行exec之前，入队命令错误，事物终止，取消，不执行。</p><h5 id="事物执行exec命令后，执行队列命令，命令执行错误，事物提交"><a href="#事物执行exec命令后，执行队列命令，命令执行错误，事物提交" class="headerlink" title="事物执行exec命令后，执行队列命令，命令执行错误，事物提交"></a>事物执行exec命令后，执行队列命令，命令执行错误，事物提交</h5><p>执行步骤:<br>1) MULTI 正常命令<br>2) SET username zhangsan 正常命令<br>3) lpop username 正常命令，语法没有错误，执行命令时才会有错误<br>4) EXEC正常执行，发现错误可以在事物提交前放弃事物，执行discard<br><img src="/images/redis/redis126.png" alt="Redis"><br>结论: 在exec执行后的所产生的错误，即使事物中有某个/某些命令在执行时产生了错误，事物中的其他命令仍然会继续执行。</p><p>Redis在事物失败时不进行回滚，而是继续执行余下的命令。</p><p>Redis这种设计原则是: Redis命令只会因为错误的语法而失败(这些问题不能在入队时发现)，或是命令用在了错误类型的键上面，失败的命令并不是Redis导致，而是由编程错误造成的，这样的错误还应该在开发中被发现，生产环境中不应出现语法的错误。就是在程序的运行环境中不应该出现语法的错误。而Redis能够保证正确的命令一定会被执行。再者不需要对回滚进行支持，所以Redis的内部可以保持简单且快速。</p><h5 id="放弃事物"><a href="#放弃事物" class="headerlink" title="放弃事物"></a>放弃事物</h5><p>1) MULTI开启事物<br>2) SET age 35 命令入队<br>3) SET age 30 命令入队<br>4) DISCARD 放弃事物，则命令队列不会被执行<br>例1:<br><img src="/images/redis/redis127.png" alt="Redis"></p><h5 id="Redis的watch机制"><a href="#Redis的watch机制" class="headerlink" title="Redis的watch机制"></a>Redis的watch机制</h5><h6 id="Redis的WATCH机制"><a href="#Redis的WATCH机制" class="headerlink" title="Redis的WATCH机制"></a>Redis的WATCH机制</h6><p>WATCH机制原理:<br>WATCH机制: 使用WATCH监视一个或多个key，跟踪key的value修改情况，如果有ley的value值在事物EXEC执行之前被修改了，整个事物被取消。EXEC返回提示信息，表示事物已经失败。</p><p>WATCH机制使的事物EXEC变得有条件，事物只有在被WATCH的key没有修改的前提下才能执行。不满足条件，事物被取消。使用WATCH监视了一个带过期时间的键，那么即使这个键过期了，事物任然可以正常执行。</p><p>大多数情况下，不同的客户端会访问不同的键，相互同时竞争同一key的情况一般都很少，乐观锁能够以很好的性能解决数据冲突的问题。</p><h6 id="何时取消key的监视-WATCH"><a href="#何时取消key的监视-WATCH" class="headerlink" title="何时取消key的监视(WATCH)?"></a>何时取消key的监视(WATCH)?</h6><p>1) WATCH命令可以被调用多次。对键的监视从WATCH执行之后开始生效，直到调用EXEC为止。不管事物是否成功执行，对所有键的监视都会被取消。<br>2) 当客户端断开连接时，该客户端对键的监视也会被取消。<br>3) UNWATCH命令可以手动取消对所有键的监视。</p><h6 id="WATCH的事例"><a href="#WATCH的事例" class="headerlink" title="WATCH的事例"></a>WATCH的事例</h6><p>执行步骤:<br>首先启动redis-server,在看起两个客户端连接。分别叫A客户端和B客户端。<br>启动Redis服务器<br><img src="/images/redis/redis128.png" alt="Redis"><br>A客户端(红色): WATCH某个key，同时执行事务<br><img src="/images/redis/redis129.png" alt="Redis"><br>B客户端(黄色): 对A客户端WATCH的key修改其value值。<br><img src="/images/redis/redis130.png" alt="Redis"></p><p>1) 在A客户端设置key:str.lp登录人数为10<br>2) 在A客户端监视key:str.lp<br>3) 在A客户端开启事物 multi<br>4) 在A客户端修改 str.lp的值为11<br>5) 在B客户端修改 str.lp的值为15<br>6) 在A客户端执行事物 exec<br>7) 在A客户端查看 str.lp的值，A客户端执行的事物没有提交，因为WATCH的str.lp的值已经被修改了，所以放弃事物。</p><p>例1: 乐观锁<br><img src="/images/redis/redis131.png" alt="Redis"></p><h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><h4 id="持久化概述"><a href="#持久化概述" class="headerlink" title="持久化概述"></a>持久化概述</h4><p>持久化可以理解为存储，就是将数据存储到一个不会丢失的地方，如果把数据放在内存中，电脑关闭或重启数据就会丢失，所以放在内存中的数据不是持久化的，而放在磁盘就算是一种持久化。</p><p>Redis的数据存储在内存中，内存是顺势的，如果linux宕机或重启，又或者Redis崩溃或重启，所有的内存数据都会丢失，为解决这个问题，Redis提供两种机制对数据进行持久化存储，便于发生故障后能迅速恢复数据。</p><h4 id="持久化方式"><a href="#持久化方式" class="headerlink" title="持久化方式"></a>持久化方式</h4><h5 id="RDB方式"><a href="#RDB方式" class="headerlink" title="RDB方式"></a>RDB方式</h5><h6 id="什么是RDB方式"><a href="#什么是RDB方式" class="headerlink" title="什么是RDB方式?"></a>什么是RDB方式?</h6><p>Redis Database(RDB)，就是在指定的时间间隔内将内存中的数据集快照写入磁盘，数据恢复时将快照文件直接再读到内存。<br>RDB保存了在某个时间点的数据集(全部数据)。存储在一个二进制文件中，只有一个文件。默认是dump.rdb。RDB技术非常适合做备份，可以保存最近一个小时，一天，一个月的全部数据。保存数据是在单独的进程中写文件，不影响Redis的正常使用。RDB恢复数据时比其他AOF速度快。</p><h6 id="如何实现"><a href="#如何实现" class="headerlink" title="如何实现?"></a>如何实现?</h6><p>RDB方式的数据持久化，仅需在redis.conf文件中配置即可，默认配置是启用的。<br>在配置文件redis.conf中搜索SNAPSHOTTING，查找在注释开始和结束文件的关于RDB的配置说明。配置SNAPSHOTTING的地方有三处。<br>1) 配置执行RDB生成快照文件的时间策略。<br>对Redis进行设置，让它在“N秒内数据集至少有M个key改动”这一条件被满足时，自动保存一次数据集。<br>配置格式: save &lt;seconds&gt; &lt;changes&gt;<br>save 900 1<br>save 300 10<br>save 60 10000<br>2) dbfilename： 设置RDB的文件名，默认文件名为dump.rdb<br>3) dir: 指定RDB文件的存储位置，默认是./当前目录</p><p>配置步骤:<br>1) 查看ps -ef | grep redis, 如果服务启动，先停止。<br>2) 修改redis.conf文件，修改前先备份，执行cp redis.conf redis.conf.bak<br>查看默认启用的RDB文件<br><img src="/images/redis/redis132.png" alt="Redis"><br>3) 编辑redis.conf增加save配置，修改文件名等。vim redis.conf<br><img src="/images/redis/redis133.png" alt="Redis"><br>修改的内容:<br><img src="/images/redis/redis134.png" alt="Redis"><br><img src="/images/redis/redis135.png" alt="Redis"><br>把原来的默认的dump.rdb删除，修改redis.conf后，重新启动redis<br>4) 在20秒内修改三个key的值<br><img src="/images/redis/redis136.png" alt="Redis"><br>5) 查看生成的rdb文件<br><img src="/images/redis/redis137.png" alt="Redis"></p><h6 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h6><p>优点: 由于存储的是数据快照文件，恢复数据很方便，也比较快<br>缺点:<br>1) 会丢失最后一次快照以后更改的数据。如果你的应用能容忍一定数据的丢失，那么使用rdb是不错的选择；如果你不能容忍一定数据的丢失，使用rdb就不是一个很好的选择。<br>2) 由于需要经常操作磁盘，RDB会分出一个子进程。如果你的reids数据库很大的话，子进程占用比较多的时间，并且可能会影响Redis暂停服务一段时间(millisecond级别),如果你的数据库超级大并且你的服务器CPU比较弱，有可能是会达到一秒。</p><h5 id="AOF方式"><a href="#AOF方式" class="headerlink" title="AOF方式"></a>AOF方式</h5><h6 id="什么是AOF方式"><a href="#什么是AOF方式" class="headerlink" title="什么是AOF方式"></a>什么是AOF方式</h6><p>Append-only File(AOF)，Redis每次接受到一条改变数据的命令是，它将把该命令写到一个AOF文件中(只记录写操作，读操作不记录),当Redis重启时，它通过执行AOF文件中所有的命令来恢复数据。</p><h6 id="如何实现-1"><a href="#如何实现-1" class="headerlink" title="如何实现"></a>如何实现</h6><p>AOF方式的数据持久化，仅需在redis.conf文件中配置即可<br>配置项:<br>1) appendonly: 默认是no，改成yes即开启了aof持久化<br>2) appendfilename: 指定AOF文件名，默认文件名为:appendonly.aof<br>3) dir: 指定RDB和AOF文件存放的目录，默认是./<br>4) appendfsync： 配置向aof文件写命令数据的策略:<br>no： 不主动进行同步操作，而是完全交由操作系统来做(即每30秒一次)，比较快但不是很安全。<br>always: 每次执行写入都会执行同步，慢一些但是比较安全。<br>everysec: 每秒执行一次同步操作,比较平衡,介于速度和安全之间。这是默认项。<br>5) auto-aof-rewrite-min-size： 允许重写的最小AOF文件大小，默认是64M。当aof文件大于64M时，开始整理aop文件，去掉无用的操作命令。缩小aop文件。</p><p>例1:<br>1) 停止运行的reids，备份要修改的redis.conf<br>2) 查看redis安装目录/src下有无.aof文件。默认是在redis的当前目录<br><img src="/images/redis/redis138.png" alt="Redis"><br>3) 编辑redis.conf<br>设置appendonly为yes即可。<br>查看appendfsync的当前策略。<br>查看appendfilename的文件名称。<br><img src="/images/redis/redis139.png" alt="Redis"><br><img src="/images/redis/redis140.png" alt="Redis"><br>4) 在redis客户端执行 写入命令<br><img src="/images/redis/redis141.png" alt="Redis"><br>5) 查看aof文件<br><img src="/images/redis/redis142.png" alt="Redis"><br><img src="/images/redis/redis143.png" alt="Redis"></p><h6 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h6><p>1) append-only文件是另一个可以提供完全数据保障的方案<br>2) AOF文件会在操作过程中变得越来越大。比如，如果你做一百次加法计算，最后你只会在数据库里面得到最终的数值，但是在你的AOF里面会存在100次记录，其中99条记录对最终的结果都是无用的；但Redis支持在不影响服务的前提下在后台重构AOF文件，让文件得以整理变小。<br>3) 可以同时使用这两种当时，redis默认优先加载aof文件(aof数据最完整);</p><h3 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h3><h4 id="主从复制–读写分离"><a href="#主从复制–读写分离" class="headerlink" title="主从复制–读写分离"></a>主从复制–读写分离</h4><p>通过持久化功能，Redis保证了即使在服务器重启的情况下也不会丢失(或少量丢失)数据，但是由于数据是存储在一台服务器上的，如果这台服务器出现故障，比如硬盘坏了，也会导致数据丢失。<br>为了避免单点故障，我们需要将数据复制多份部署在多台不同的服务器上，即使有一台服务器出现故障其他扶我去依然可以继续提供服务。<br>这就要求当一台服务器上的数据更新后，自动将更新的数据同步到其他服务器上，那该怎么实现呢?Redis的主从复制。<br><img src="/images/redis/redis144.png" alt="Redis"><br>Redis提供了复制(replication)功能来自动实现多台redis服务器的数据同步(每天19点新闻联播,基本从cctv1-8，各大卫视都会播放)<br>我们可以通过部署多台redis，并在配置文件中指定这几台redis之间的主从关系，主负责写入数据，同时把写入的数据实时同步到从机器，这种模式叫做主从复制，即master/slave,并且redis默认master用于写，slave用于读，向slave写数据会导致错误。</p><h5 id="Redis主从复制实现-master-salve"><a href="#Redis主从复制实现-master-salve" class="headerlink" title="Redis主从复制实现(master/salve)"></a>Redis主从复制实现(master/salve)</h5><p>方式1: 修改配置文件，启动时，服务器读取配置文件，并自动成为指定服务器的从服务器，从而构成主从复制的关系。<br>方式2: ./redis-server -slaveof &lt;master-ip&gt; &lt;master-port&gt;,在启动redis时指定当前服务成为某个主Redis服务器的从Slave。</p><p>方式1的实现步骤:<br>模拟多Redis服务器，在一台已经安装Redis的机器上，运行多个Redis应用模拟多个Redis服务器。一个Master，两个Slave。</p><h6 id="新建三个Redis的配置文件"><a href="#新建三个Redis的配置文件" class="headerlink" title="新建三个Redis的配置文件"></a>新建三个Redis的配置文件</h6><p>如果Redis启动，先停止。<br>作为Master的Redis端口是6380<br>作为Slave的Redis端口分别是6382，6384<br>从原有的redis.conf拷贝三份，分别命名为redis6380.conf,redis6382.conf, redis6384.conf<br><img src="/images/redis/redis145.png" alt="Redis"></p><h6 id="编辑Master配置文件"><a href="#编辑Master配置文件" class="headerlink" title="编辑Master配置文件"></a>编辑Master配置文件</h6><p>编辑Master的配置文件redis6380.conf: 在空文件加入如下内容<br>include /usr/local/redis-3.2.9/redis.conf<br>daemonize yes<br>port 6380<br>pidfile /var/run/redis_6380.pid<br>logfile 6380.log<br>dbfilename dump6380.rdb</p><p>配置项说明:<br>include： 包含原来的配置文件内容。/usr/local/redis-3.3.9/redis.conf按照自己的目录设置。<br>daemonize: yes 后台启动应用,相当于./redis-server &amp;， &amp;的作用。<br>port: 自定义的端口号<br>pidfile: 自定义的文件，表示当前程序的pid,进程id。<br>logfile: 日志文件<br>dbfilename: 持久化的rdb文件名</p><h6 id="编辑Slave配置文件"><a href="#编辑Slave配置文件" class="headerlink" title="编辑Slave配置文件"></a>编辑Slave配置文件</h6><p>编辑Slave的配置文件redis6382.conf和redis6384.conf： 在空文件加入如下内容<br>1） redis6382.conf:<br>include /usr/local/redis-3.2.9/redis.conf<br>daemonize yes<br>port 6382<br>pidfile /var/run/redis_6382.pid<br>logfile 6382.log<br>dbfilename dump6382.rdb<br>slaveof 127.0.0.1 6380</p><p>配置项说明:<br>slaveof： 表示当前Redis是谁的从。当前是127.0.0.1 端口是6380这个Master的从。</p><p>2） redis6384.conf:<br>include /usr/local/redis-3.2.9/redis.conf<br>daemonize yes<br>port 6384<br>pidfile /var/run/redis_6384.pid<br>logfile 6384.log<br>dbfilename dump6384.rdb<br>slaveof 127.0.0.1 6380</p><h6 id="启动服务器-Master-Slave都启动"><a href="#启动服务器-Master-Slave都启动" class="headerlink" title="启动服务器 Master/Slave都启动"></a>启动服务器 Master/Slave都启动</h6><p>启动方式 ./redis-server 配置文件<br>启动Redis，并查看启动进程<br><img src="/images/redis/redis146.png" alt="Redis"></p><h6 id="查看配置后的服务信息"><a href="#查看配置后的服务信息" class="headerlink" title="查看配置后的服务信息"></a>查看配置后的服务信息</h6><p>命令:<br>1) Reids客户端使用指定端口连接Redis服务器<br>./redis-cli -p 端口<br>2) 查看服务器信息<br>info replication</p><p>登录到Master: 6380</p><p><img src="/images/redis/redis147.png" alt="Redis"><br>查看当前服务信息<br>在客户端的Redis内执行命令 info replication<br>Master服务的查看结果:<br><img src="/images/redis/redis148.png" alt="Redis"></p><p>在新的Xshell窗口分别登录到6382，6384查看信息<br><img src="/images/redis/redis149.png" alt="Redis"><br>6384登录内容也同6382。</p><h6 id="向Master写入数据"><a href="#向Master写入数据" class="headerlink" title="向Master写入数据"></a>向Master写入数据</h6><p>在6380执行flushall清除数据，避免干扰的测试数据。生产环境避免使用。<br><img src="/images/redis/redis150.png" alt="Redis"></p><h6 id="在从Salve读数据"><a href="#在从Salve读数据" class="headerlink" title="在从Salve读数据"></a>在从Salve读数据</h6><p>6382,6384都可以读主Master的数据，不能写<br><img src="/images/redis/redis151.png" alt="Redis"></p><p>Salve写数据失败<br><img src="/images/redis/redis152.png" alt="Redis"></p><h5 id="容灾处理"><a href="#容灾处理" class="headerlink" title="容灾处理"></a>容灾处理</h5><p>当Master服务出现故障，需手动将slave中的一个提升为master，剩下的slave挂至新的master上(冷处理:机器挂掉了，再处理)<br>命令:<br>1) slaveof no one, 将一台slave服务器提升为Master(提升某slave为master)<br>2) slaveof 127.0.0.1 6381 (将slave挂至新的master上)</p><p>执行步骤:</p><h6 id="将Master-6380停止-模拟挂掉"><a href="#将Master-6380停止-模拟挂掉" class="headerlink" title="将Master:6380停止 (模拟挂掉)"></a>将Master:6380停止 (模拟挂掉)</h6><p><img src="/images/redis/redis153.png" alt="Redis"><br><img src="/images/redis/redis154.png" alt="Redis"></p><h6 id="选择一个Slave升到Master，其它的Slave挂到新提升的Master"><a href="#选择一个Slave升到Master，其它的Slave挂到新提升的Master" class="headerlink" title="选择一个Slave升到Master，其它的Slave挂到新提升的Master"></a>选择一个Slave升到Master，其它的Slave挂到新提升的Master</h6><p><img src="/images/redis/redis155.png" alt="Redis"></p><h6 id="将其它Slave挂到新的Master"><a href="#将其它Slave挂到新的Master" class="headerlink" title="将其它Slave挂到新的Master"></a>将其它Slave挂到新的Master</h6><p>在Slave 6384身上执行<br><img src="/images/redis/redis156.png" alt="Redis"><br>现在的主(Master/Slave)关系: Master是6382， Slave是6384<br>查看6382:<br><img src="/images/redis/redis157.png" alt="Redis"></p><h6 id="原来的服务器重新添加到主从结构中"><a href="#原来的服务器重新添加到主从结构中" class="headerlink" title="原来的服务器重新添加到主从结构中"></a>原来的服务器重新添加到主从结构中</h6><p>6380的服务器修改后，从新工作，需要把它添加到现有的Master/Slave中<br>先启动6380的Redis服务<br><img src="/images/redis/redis158.png" alt="Redis"><br>连接到6380端口<br><img src="/images/redis/redis159.png" alt="Redis"><br>当前服务挂到Master上<br><img src="/images/redis/redis160.png" alt="Redis"></p><h6 id="查看新的Master信息"><a href="#查看新的Master信息" class="headerlink" title="查看新的Master信息"></a>查看新的Master信息</h6><p>在6382执行:<br><img src="/images/redis/redis161.png" alt="Redis"><br>现在的Master/Slave关系是:<br>Master: 6382<br>Slave: 6380<br>Slave: 6384</p><h5 id="操作命令"><a href="#操作命令" class="headerlink" title="操作命令"></a>操作命令</h5><p>进入客户端需指定端口 ./redis-cli -p 6380<br>不配置启动默认都是主master<br>info replication 查看redis服务器所处角色</p><h5 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h5><p>1) 一个master可以有多个slave<br>2) salve下线，读请求的处理性能下降<br>3) master下线，写请求无法执行<br>4) 当master发生故障，需手动将其中一条slave使用slaveof no noe命令提示为master，其它slave执行slaveof命令指向这个新的master，从新的master处同步数据<br>5) 主从复制模式的故障转移需要手动操作，要实现自动化处理，这就需要Sentinel哨兵，实现故障自动转移。</p><h4 id="高可用Sentinel哨兵"><a href="#高可用Sentinel哨兵" class="headerlink" title="高可用Sentinel哨兵"></a>高可用Sentinel哨兵</h4><p>Snentinel哨兵是redis官方提供的高可用方案，可用用它来监控多个Redis服务实例的运行情况。Redis Sendtinel是一个运行在特使模式下的Redis服务器。Redis Sentinel是在多个Sentinel进程环境下相互协作工作的。</p><p>Sentinel系统有三个主要任务</p><ul><li>监控: Sentinel不断的检查主服务和从服务器是否按照预期正常工作。</li><li>提醒: 被监控的Redis出现问题时，Sentinel会通知管理员或其他应用程序。</li><li>自动故障转移: 监控的主Redis不能正常工作，Sentinel会开始进行故障迁移操作。将一个从服务器升级新的主服务器。让其他从服务器挂到新的主服务器。同时向客户端提供新的主服务器地址。<br><img src="/images/redis/redis162.png" alt="Redis"></li></ul><h5 id="Sentinel配置"><a href="#Sentinel配置" class="headerlink" title="Sentinel配置"></a>Sentinel配置</h5><p>Sentinel配置文件<br>复制三份Sentinel.conf文件:<br><img src="/images/redis/redis163.png" alt="Redis"></p><p>Sentinel系统默认port是26379。 三个配置port分别设置为26380， 26382， 26384。<br>三个文件分别命名为:</p><ul><li>sentinel26380.conf</li><li>sentinel26382.conf</li><li>sentinel26384.conf<br>执行复制命令 cp sentinel.conf xxx.conf<br><img src="/images/redis/redis164.png" alt="Redis"></li></ul><h5 id="三份sentinel配置文件修改"><a href="#三份sentinel配置文件修改" class="headerlink" title="三份sentinel配置文件修改:"></a>三份sentinel配置文件修改:</h5><p>1) 修改port 26380、 port 26382、 port 26384<br>2) 修改sentinel monitor mymaster 127.0.0.1 6380 2<br>格式: sentinel monitor &lt;name&gt; &lt;masterIP&gt; &lt;masterPort&gt; &lt;Quorum投票数&gt;</p><p>Sentinel监控主(Master)Redis,Sentinel根据Master的配置自动发现Master的Slave，Sentinel默认端口号为26379。<br><img src="/images/redis/redis165.png" alt="Redis"><br>sentinel26380.conf<br>1) 修改port<br><img src="/images/redis/redis166.png" alt="Redis"><br>2) 修改监控的master地址<br><img src="/images/redis/redis167.png" alt="Redis"><br>sentinel26382.conf 修改port 26382， master的port 6382<br>sentinel26384.conf 修改port 26384， master的port 6382</p><h5 id="启动主从-Master-Slave-Redis"><a href="#启动主从-Master-Slave-Redis" class="headerlink" title="启动主从(Master/Slave) Redis"></a>启动主从(Master/Slave) Redis</h5><p>启动Redis<br><img src="/images/redis/redis168.png" alt="Redis"></p><p>查看Master的配置信息<br>连接到6382<br><img src="/images/redis/redis169.png" alt="Redis"><br>使用info命令查看Master/Slave<br><img src="/images/redis/redis170.png" alt="Redis"></p><h5 id="启动Sentinel"><a href="#启动Sentinel" class="headerlink" title="启动Sentinel"></a>启动Sentinel</h5><p>redis安装时make编译后就产生了redis-sentinel程序文件，可以在一个redis中运行多个sentinel进程。</p><p>启动一个运行在Sentinel模式下的Redis服务实例<br>./redis-sentinel sentinel配置文件</p><p>执行以下三条命令，将创建三个监视主服务器的Sentinel实例<br>./redis-sentinel ../sentinel26380.conf<br>./redis-sentinel ../sentinel26382.conf<br>./redis-sentinel ../sentinel26384.conf</p><p>在XShell开启三个窗口分别执行:<br><img src="/images/redis/redis171.png" alt="Redis"><br><img src="/images/redis/redis172.png" alt="Redis"><br><img src="/images/redis/redis173.png" alt="Redis"></p><h5 id="主Redis不能工作"><a href="#主Redis不能工作" class="headerlink" title="主Redis不能工作"></a>主Redis不能工作</h5><p>让Master的Redis停止服务，执行shutdown<br>先执行info replication确认Master的Redis，在执行shutdown<br><img src="/images/redis/redis174.png" alt="Redis"></p><p>查看当前Redis的进程情况<br><img src="/images/redis/redis175.png" alt="Redis"></p><h5 id="Sentinel起的作用"><a href="#Sentinel起的作用" class="headerlink" title="Sentinel起的作用"></a>Sentinel起的作用</h5><p>在Master执行shutdown后，稍微等一会Sentinel要进行投票计算，从可用的Slave选举新的Master。<br>查看Sentinel日志，三个Sentinel窗口的日志是一样的。<br><img src="/images/redis/redis176.png" alt="Redis"></p><p>查看新的Master<br><img src="/images/redis/redis177.png" alt="Redis"></p><p>查看原Slave的变化<br><img src="/images/redis/redis178.png" alt="Redis"></p><h5 id="新的Redis加入Sentinel系统，自动加入Master"><a href="#新的Redis加入Sentinel系统，自动加入Master" class="headerlink" title="新的Redis加入Sentinel系统，自动加入Master"></a>新的Redis加入Sentinel系统，自动加入Master</h5><p>重新启动6382<br><img src="/images/redis/redis179.png" alt="Redis"><br>查看6384的信息<br><img src="/images/redis/redis180.png" alt="Redis"><br>测试数据：在Master写入数据<br><img src="/images/redis/redis181.png" alt="Redis"><br>在6382写入数据，不能写入<br><img src="/images/redis/redis182.png" alt="Redis"></p><h5 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h5><p>1) Sentinel会不断检查Master和Slave是否正常。<br>2) 如果Sentinel挂了，就无法监控，所以需要多个哨兵，组成Sentinel网络，一个健康的Sentinel至少有3个应用。彼此在独立的物理机器或虚拟机。<br>3) 监控同一个Master的Sentinel会自动连接，组成一个分布式的Sentinel网络，互相通信并交换彼此关于被监控服务器的信息。<br>4) 当一个Sentinel认为被监控的服务器已经下线时，它会向网络中的其它Sentinel进行确认，判断该服务器是否真的已经下线。<br>5) 如果下线的服务器为主服务器，那么Sentinel网络将对下线主服务器进行自动故障转移，通过将下线的主服务的某个服务器提升为新的主服务器，并让其从服务器转移到新的主服务器下，以此来让系统重新回到正常状态。<br>6) 下线的旧主服务器重新上线，Sentinel会让它成为从，挂到新的主服务器下。</p><h5 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h5><p>主从复制，解决了读请求的负担，从节点下线，会使得读请求能力有所下降，Master下线，写请求无法执行。<br>Sentinel会在Master下线后自动执行故障转移操作，提升一台Slave为Master，并让其它Slave成为新的Master的Slave。</p><h3 id="安全设置"><a href="#安全设置" class="headerlink" title="安全设置"></a>安全设置</h3><h4 id="设置密码"><a href="#设置密码" class="headerlink" title="设置密码"></a>设置密码</h4><p>访问Redis默认是没有密码的，这样不安全，任意用户都可以访问。可以启动使用密码才能访问Redis。设置Redis的访问密码，修改redis.conf中这行requirepass密码。密码要比较复杂，不容易破解，而且需要定期修改。因为redis速度相当快，所以在一台比较好的服务器下，一个外部用户可以再一秒钟进行150K次的密码尝试，需要指定非常非常强的密码来防止暴力破解。</p><h5 id="开启访问密码设置"><a href="#开启访问密码设置" class="headerlink" title="开启访问密码设置"></a>开启访问密码设置</h5><p>修改redis.conf，使用vim命令。找到requirepass行去掉注释，requirepass空格后就是密码。<br>例1: 设置访问密码是123456，这是练习使用，生产环境要设置复杂的密码<br>修改redis.conf，文件480行左右。原始内容:<br><img src="/images/redis/redis183.png" alt="Redis"><br>修改后:<br><img src="/images/redis/redis184.png" alt="Redis"><br>查看修改结果:<br><img src="/images/redis/redis185.png" alt="Redis"></p><h5 id="访问有密码的Redis"><a href="#访问有密码的Redis" class="headerlink" title="访问有密码的Redis"></a>访问有密码的Redis</h5><p>如果Redis已经启动，关闭后重新启动。</p><p>访问有密码的Redis两种方式:<br>1) 在连接到客户端后,使用命令auth 密码，命令执行成功后，可以正常使用Redis<br>2) 在连接客户端时使用-a密码。例如./redis-cli -h ip -p port -a password</p><p>启动Redis<br><img src="/images/redis/redis186.png" alt="Redis"><br>使用1)访问<br><img src="/images/redis/redis187.png" alt="Redis"><br>输入命令auth密码<br><img src="/images/redis/redis188.png" alt="Redis"></p><p>使用2)方式<br><img src="/images/redis/redis189.png" alt="Redis"></p><h4 id="绑定ip"><a href="#绑定ip" class="headerlink" title="绑定ip"></a>绑定ip</h4><p>修改redis.conf文件，把# bind 127.0.0.1前面的注释#去掉，然后把127.0.0.1改成允许访问你redis服务器的ip地址，表示只允许该ip进行访问。多个ip使用空格分割。<br>例如 bind 192.168.1.100 192.168.1.10</p><h4 id="修改默认端口"><a href="#修改默认端口" class="headerlink" title="修改默认端口"></a>修改默认端口</h4><p>修改redis的端口，这一点很重要，使用默认的端口很危险，redis.conf中修改port 6379将其修改为自己指定的端口(可随意),端口1024是保留给操作系统使用的。用户可以使用的范围是1024-65535<br><img src="/images/redis/redis190.png" alt="Redis"></p><p>使用 -p 参数指定端口，例如: ./redis-cli -p 新设置端口</p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">------ 本文结束------</div></div></div><div></div><div><div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id="wechat_subscriber_qcode" src="/images/information/wechat-qcode.jpg" alt="caifenglin wechat" style="width:200px;max-width:100%"><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>坚持原创技术分享，您的支持将鼓励我继续创作！</div><button id="rewardButton" disable="enable" onclick='var e=document.getElementById("QR");"none"===e.style.display?e.style.display="block":e.style.display="none"'><span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/images/information/wechatpay.png" alt="caifenglin 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"><img id="alipay_qr" src="/images/information/alipay.jpg" alt="caifenglin 支付宝"><p>支付宝</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong> caifenglin</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="http://smartdot.club/数据库/Redis/e36135cb.html" title="第4章 高级话题">http://smartdot.club/数据库/Redis/e36135cb.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Redis/" rel="tag"><i class="fa fa-tag"></i> Redis</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/Nginx/f8a6e8f7.html" rel="next" title="第1章 Nginx介绍"><i class="fa fa-chevron-left"></i> 第1章 Nginx介绍</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/Nginx/966c5443.html" rel="prev" title="第3章 Nginx优化">第3章 Nginx优化 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="gitment-container"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/information/avatar.jpg" alt="caifenglin"><p class="site-author-name" itemprop="name">caifenglin</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">31</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">18</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">14</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/caifenglin" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://gitee.com/caifenglin" target="_blank" title="码云"><i class="fa fa-fw fa-gg"></i>码云</a> </span><span class="links-of-author-item"><a href="mailto:y724329369@qq.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://plus.google.com/caifenglin1314" target="_blank" title="Google"><i class="fa fa-fw fa-globe"></i>Google</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://springbook.cn/" title="个人网站" target="_blank">个人网站</a></li><li class="links-of-blogroll-item"><a href="http://springbook.cn:10000/" title="Gogs" target="_blank">Gogs</a></li><li class="links-of-blogroll-item"><a href="http://caifenglin.gitee.io/es6/" title="ECMAScript6" target="_blank">ECMAScript6</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis事物"><span class="nav-number">1.</span> <span class="nav-text">Redis事物</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#什么是事物"><span class="nav-number">1.1.</span> <span class="nav-text">什么是事物</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#事物操作的命令"><span class="nav-number">1.2.</span> <span class="nav-text">事物操作的命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#multi"><span class="nav-number">1.2.1.</span> <span class="nav-text">multi</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#exec"><span class="nav-number">1.2.2.</span> <span class="nav-text">exec</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#discard"><span class="nav-number">1.2.3.</span> <span class="nav-text">discard</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#watch"><span class="nav-number">1.2.4.</span> <span class="nav-text">watch</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#unwatch"><span class="nav-number">1.2.5.</span> <span class="nav-text">unwatch</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#事物的实现"><span class="nav-number">1.3.</span> <span class="nav-text">事物的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#正常执行事物"><span class="nav-number">1.3.1.</span> <span class="nav-text">正常执行事物</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#事物执行exec之前，入队命令错误-语法错误；严重错误导致服务器不能正常工作-例如内存不足-放弃事物。"><span class="nav-number">1.3.2.</span> <span class="nav-text">事物执行exec之前，入队命令错误(语法错误；严重错误导致服务器不能正常工作(例如内存不足)),放弃事物。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#事物执行exec命令后，执行队列命令，命令执行错误，事物提交"><span class="nav-number">1.3.3.</span> <span class="nav-text">事物执行exec命令后，执行队列命令，命令执行错误，事物提交</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#放弃事物"><span class="nav-number">1.3.4.</span> <span class="nav-text">放弃事物</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Redis的watch机制"><span class="nav-number">1.3.5.</span> <span class="nav-text">Redis的watch机制</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Redis的WATCH机制"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">Redis的WATCH机制</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#何时取消key的监视-WATCH"><span class="nav-number">1.3.5.2.</span> <span class="nav-text">何时取消key的监视(WATCH)?</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#WATCH的事例"><span class="nav-number">1.3.5.3.</span> <span class="nav-text">WATCH的事例</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#持久化"><span class="nav-number">2.</span> <span class="nav-text">持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#持久化概述"><span class="nav-number">2.1.</span> <span class="nav-text">持久化概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#持久化方式"><span class="nav-number">2.2.</span> <span class="nav-text">持久化方式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#RDB方式"><span class="nav-number">2.2.1.</span> <span class="nav-text">RDB方式</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#什么是RDB方式"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">什么是RDB方式?</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#如何实现"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">如何实现?</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#总结"><span class="nav-number">2.2.1.3.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AOF方式"><span class="nav-number">2.2.2.</span> <span class="nav-text">AOF方式</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#什么是AOF方式"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">什么是AOF方式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#如何实现-1"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">如何实现</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#总结-1"><span class="nav-number">2.2.2.3.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主从复制"><span class="nav-number">3.</span> <span class="nav-text">主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主从复制–读写分离"><span class="nav-number">3.1.</span> <span class="nav-text">主从复制–读写分离</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Redis主从复制实现-master-salve"><span class="nav-number">3.1.1.</span> <span class="nav-text">Redis主从复制实现(master/salve)</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#新建三个Redis的配置文件"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">新建三个Redis的配置文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#编辑Master配置文件"><span class="nav-number">3.1.1.2.</span> <span class="nav-text">编辑Master配置文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#编辑Slave配置文件"><span class="nav-number">3.1.1.3.</span> <span class="nav-text">编辑Slave配置文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#启动服务器-Master-Slave都启动"><span class="nav-number">3.1.1.4.</span> <span class="nav-text">启动服务器 Master/Slave都启动</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#查看配置后的服务信息"><span class="nav-number">3.1.1.5.</span> <span class="nav-text">查看配置后的服务信息</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#向Master写入数据"><span class="nav-number">3.1.1.6.</span> <span class="nav-text">向Master写入数据</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#在从Salve读数据"><span class="nav-number">3.1.1.7.</span> <span class="nav-text">在从Salve读数据</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#容灾处理"><span class="nav-number">3.1.2.</span> <span class="nav-text">容灾处理</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#将Master-6380停止-模拟挂掉"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">将Master:6380停止 (模拟挂掉)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#选择一个Slave升到Master，其它的Slave挂到新提升的Master"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">选择一个Slave升到Master，其它的Slave挂到新提升的Master</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#将其它Slave挂到新的Master"><span class="nav-number">3.1.2.3.</span> <span class="nav-text">将其它Slave挂到新的Master</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#原来的服务器重新添加到主从结构中"><span class="nav-number">3.1.2.4.</span> <span class="nav-text">原来的服务器重新添加到主从结构中</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#查看新的Master信息"><span class="nav-number">3.1.2.5.</span> <span class="nav-text">查看新的Master信息</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#操作命令"><span class="nav-number">3.1.3.</span> <span class="nav-text">操作命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#总结-2"><span class="nav-number">3.1.4.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#高可用Sentinel哨兵"><span class="nav-number">3.2.</span> <span class="nav-text">高可用Sentinel哨兵</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Sentinel配置"><span class="nav-number">3.2.1.</span> <span class="nav-text">Sentinel配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#三份sentinel配置文件修改"><span class="nav-number">3.2.2.</span> <span class="nav-text">三份sentinel配置文件修改:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#启动主从-Master-Slave-Redis"><span class="nav-number">3.2.3.</span> <span class="nav-text">启动主从(Master/Slave) Redis</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#启动Sentinel"><span class="nav-number">3.2.4.</span> <span class="nav-text">启动Sentinel</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#主Redis不能工作"><span class="nav-number">3.2.5.</span> <span class="nav-text">主Redis不能工作</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Sentinel起的作用"><span class="nav-number">3.2.6.</span> <span class="nav-text">Sentinel起的作用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#新的Redis加入Sentinel系统，自动加入Master"><span class="nav-number">3.2.7.</span> <span class="nav-text">新的Redis加入Sentinel系统，自动加入Master</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#监控"><span class="nav-number">3.2.8.</span> <span class="nav-text">监控</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#总结-3"><span class="nav-number">3.2.9.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安全设置"><span class="nav-number">4.</span> <span class="nav-text">安全设置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#设置密码"><span class="nav-number">4.1.</span> <span class="nav-text">设置密码</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#开启访问密码设置"><span class="nav-number">4.1.1.</span> <span class="nav-text">开启访问密码设置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#访问有密码的Redis"><span class="nav-number">4.1.2.</span> <span class="nav-text">访问有密码的Redis</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#绑定ip"><span class="nav-number">4.2.</span> <span class="nav-text">绑定ip</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改默认端口"><span class="nav-number">4.3.</span> <span class="nav-text">修改默认端口</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span> <span class="with-love"><i class="fa fa-heart-o"></i> </span><span class="author" itemprop="copyrightHolder">caifenglin</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">43.4k</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css"><script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script><script type="text/javascript">function renderGitment(){var n=new Gitmint({id:window.location.pathname,owner:"caifenglin",repo:"caifenglin.github.io",lang:navigator.language||navigator.systemLanguage||navigator.userLanguage,oauth:{client_secret:"908b65bfc6a0f32b32aefd7899476e0c9a6685c3",client_id:"bf00a5920c0c1496a121"}});n.render("gitment-container")}renderGitment()</script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;w<0&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/haru01.model.json"},display:{position:"right",width:116,height:460},mobile:{show:!0},log:!1})</script></body></html><!-- rebuild by neat -->